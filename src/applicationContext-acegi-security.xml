<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd">

	<bean id="filterChainProxy"
		class="org.acegisecurity.util.FilterChainProxy">
		<property name="filterInvocationDefinitionSource">

			<value>
				CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISON
				PATTERN_TYPE_APACHE_ANT
				/**=httpSessionContextIntegrationFilter,logoutFilter,authenticationProcessingFilter,securityContextHolderAwareRequestFilter,anonymousProcessingFilter,exceptionTranslationFilter,filterInvocationInterceptor                
            </value>

		</property>
	</bean>
    
    <bean id="httpSessionContextIntegrationFilter"
		class="org.acegisecurity.context.HttpSessionContextIntegrationFilter" />

    <bean id="logoutFilter"
		class="org.acegisecurity.ui.logout.LogoutFilter">
		<constructor-arg value="/public/login" />
		<!-- URL redirected to after logout -->
		<constructor-arg>
			<list>
				<bean
					class="org.acegisecurity.ui.logout.SecurityContextLogoutHandler" />
			</list>
		</constructor-arg>
	</bean>

    <bean id="authenticationProcessingFilter"
		class="org.acegisecurity.ui.webapp.AuthenticationProcessingFilter">
		<property name="authenticationManager"
			ref="authenticationManager" />
		<property name="authenticationFailureUrl" value="/public/login?login_error=1" />
		<property name="defaultTargetUrl" value="/" />
		<property name="filterProcessesUrl"
			value="/j_acegi_security_check" />
	</bean>

    <bean id="authenticationManager"
		class="org.acegisecurity.providers.ProviderManager">
		<property name="providers">
			<list>
				<ref local="csmAuthenticationProvider" />
				<!--TODO: add this <ref local="gridAuthenticationProvider" />-->
				<!--TODO: add this? <ref local="globusCredentialAuthenticationProvider" />-->
				<bean
					class="org.acegisecurity.providers.anonymous.AnonymousAuthenticationProvider">
					<property name="key" value="anonymousAuthKey" />
				</bean>
			</list>
		</property>

	</bean>

    <bean id="csmAuthenticationProvider"
		class="gov.nih.nci.security.acegi.csm.authentication.CSMAuthenticationProvider">

		<property name="csmAuthenticationManager">
			<bean class="gov.nih.nci.security.SecurityServiceProvider"
				factory-method="getAuthenticationManager">
				<constructor-arg ref="csmContextName" />
			</bean>
		</property>

		<property name="userDetailsService">
			<bean
				class="gov.nih.nci.security.acegi.csm.authorization.CSMUserDetailsService">
				<property name="csmUserProvisioningManager"
					ref="userProvisioningManager" />
			</bean>
		</property>

		<property name="userCache" ref="userCache" />
	</bean>

    <bean id="userCache"
		class="org.acegisecurity.providers.dao.cache.EhCacheBasedUserCache">
		<property name="cache">
			<bean
				class="org.springframework.cache.ehcache.EhCacheFactoryBean">
				<property name="cacheManager">
					<bean
						class="org.springframework.cache.ehcache.EhCacheManagerFactoryBean" />
				</property>
				<property name="cacheName" value="userCache" />

			</bean>
		</property>
	</bean>

    <bean id="authenticationProcessingFilterEntryPoint"
		class="org.acegisecurity.ui.webapp.AuthenticationProcessingFilterEntryPoint">
		<property name="loginFormUrl" value="/public/login" />
		<property name="forceHttps" value="false" />
	</bean>

    <bean id="securityContextHolderAwareRequestFilter"
		class="org.acegisecurity.wrapper.SecurityContextHolderAwareRequestFilter" />

    <bean id="anonymousProcessingFilter"
		class="org.acegisecurity.providers.anonymous.AnonymousProcessingFilter">
		<property name="key" value="anonymousAuthKey" />
		<property name="userAttribute"
			value="anonymousUser,ROLE_ANONYMOUS" />
	</bean>


	<bean id="exceptionTranslationFilter"
		class="org.acegisecurity.ui.ExceptionTranslationFilter">
		<property name="authenticationEntryPoint"
			ref="authenticationProcessingFilterEntryPoint" />
		<property name="accessDeniedHandler">
			<bean
				class="org.acegisecurity.ui.AccessDeniedHandlerImpl">
				<property name="errorPage" value="/accessDenied.jsp" />
			</bean>
		</property>
	</bean>

    <bean id="filterInvocationInterceptor"
		class="org.acegisecurity.intercept.web.FilterSecurityInterceptor">
		<property name="authenticationManager"
			ref="authenticationManager" />
		<property name="accessDecisionManager">
			<bean class="org.acegisecurity.vote.AffirmativeBased">
				<property name="allowIfAllAbstainDecisions"
					value="false" />
				<property name="decisionVoters">

					<list>
						<bean
							class="gov.nih.nci.security.acegi.csm.vote.AuthorizationSwitchVoter">
							<property name="authorizationSwitch"
								ref="authorizationSwitch" />
						</bean>
						<bean
							class="gov.nih.nci.security.acegi.csm.vote.CSMAuthorizationCheckVoter">
							<property name="processConfigAttribute"
								value="CSM_FILTER_CHECK" />
							<property name="authorizationCheck"
								ref="filterAuthorizationCheck" />
						</bean>

					</list>
				</property>
			</bean>
		</property>

		<property name="objectDefinitionSource">
			<value>
				CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISON
				\A/pages/.*\Z=CSM_FILTER_CHECK
			</value>

		</property>
	</bean>

    <bean id="filterAuthorizationCheck" autowire="byType"
		class="gov.nih.nci.security.acegi.csm.authorization.DelegatingObjectPrivilegeCSMAuthorizationCheck">
		<property name="csmAuthorizationCheck">
			<bean
				class="gov.nih.nci.security.acegi.grid.authorization.CSMGridGroupAuthorizationCheck">
				<property name="csmUserProvisioningManager"
					ref="userProvisioningManager" />
                <property name="authorizationSwitch" ref="authorizationSwitch"/>
            </bean>
		</property>
		<property name="objectIdGenerator"
			ref="filterPrivilegeAndObjectIdGenerator" />
		<property name="privilegeGenerator"
			ref="filterPrivilegeAndObjectIdGenerator" />
	</bean>

    <bean id="filterPrivilegeAndObjectIdGenerator"
		class="edu.northwestern.bioinformatics.studycalendar.security.FilterInvocationPrivilegeAndObjectIdGenerator">
		<property name="objectPrivilegeMap"
			ref="filterObjectPrivilegeMap" />
	</bean>

    <util:map id="filterObjectPrivilegeMap"
		map-class="java.util.LinkedHashMap">
		<entry key="/pages/admin/configure\??.*"
               value="/pages/admin/configure:ACCESS" />
        <entry key="/pages/admin\??.*"
               value="/pages/admin:ACCESS" />
        <entry key="/pages/api\??.*"
               value="/pages/api:ACCESS" />
        <entry key="/pages/cal/assignParticipant\??.*"
               value="/pages/cal/assignParticipant:ACCESS" />
        <entry key="/pages/cal/assignParticipantCoordinatorsToSite\??.*"
               value="/pages/cal/assignParticipantCoordinatorsToSite:ACCESS" />
        <entry key="/pages/cal/assignSite\??.*"
               value="/pages/cal/assignSite:ACCESS" />
        <entry key="/pages/admin/manage/assignSiteCoordinator\??.*"
               value="/pages/admin/manage/assignSiteCoordinator:ACCESS" />
        <entry key="/pages/assignTemplatesToOneParticipantCoordinator\??.*"
               value="/pages/assignTemplatesToOneParticipantCoordinator:ACCESS" />
        <entry key="/pages/admin/manage/createUser\??.*"
               value="/pages/admin/manage/createUser:ACCESS" />
        <entry key="/pages/cal/template/addTo\??.*"
               value="/pages/cal/template/addTo:ACCESS" />
        <entry key="/pages/cal/amendment\??.*"
               value="/pages/cal/amendment:ACCESS" />
        <entry key="/pages/generateReport\??.*"
               value="/pages/generateReport:ACCESS" />
        <entry key="/pages/admin/manage/holidays\??.*"
               value="/pages/admin/manage/holidays:ACCESS" />
        <entry key="/pages/admin/manage/listUsers\??.*"
               value="/pages/admin/manage/listUsers:ACCESS" />
        <entry key="/pages/admin/manage/sites\??.*"
               value="/pages/admin/manage/sites:ACCESS" />
        <entry key="/pages/cal/createParticipant\??.*"
               value="/pages/cal/createParticipant:ACCESS" />
        <entry key="/pages/admin/manage/newSite\??.*"
               value="/pages/admin/manage/newSite:ACCESS" />
        <entry key="/pages/cal/assignParticipantCoordinator\??.*"
               value="/pages/cal/assignParticipantCoordinator:ACCESS" />
        <entry key="/pages/cal/assignParticipantCoordinator/selectSite\??.*"
               value="/pages/cal/assignParticipantCoordinator/selectSite:ACCESS" />
        <entry key="/pages/report/builder\??.*"
               value="/pages/report/builder:ACCESS" />
        <entry key="/pages/report/builder/selectDateRange\??.*"
               value="/pages/report/builder/selectDateRange:ACCESS" />
        <entry key="/pages/report/builder/selectParticipants\??.*"
               value="/pages/report/builder/selectParticipants:ACCESS" />
        <entry key="/pages/report/builder/selectSites\??.*"
               value="/pages/report/builder/selectSites:ACCESS" />
        <entry key="/pages/report/builder/selectStudies\??.*"
               value="/pages/report/builder/selectStudies:ACCESS" />
        <entry key="/pages/simpleReport\??.*"
               value="/pages/simpleReport:ACCESS" />
        <entry key="/pages/cal/schedule/select\??.*"
               value="/pages/cal/schedule/select:ACCESS" />
        <entry key="/pages/cal/schedule/batch\??.*"
               value="/pages/cal/schedule/batch:ACCESS" />
        <entry key="/pages/cal/schedule/dismissAe\??.*"
               value="/pages/cal/schedule/dismissAe:ACCESS" />
        <entry key="/pages/cal/schedule\??.*"
               value="/pages/cal/schedule:ACCESS" />
        <entry key="/pages/cal/scheduleEvent\??.*"
               value="/pages/cal/scheduleEvent:ACCESS" />
        <entry key="/pages/cal/schedule/nextArm\??.*"
               value="/pages/cal/schedule/nextArm:ACCESS" />
        <entry key="/pages/cal/scheduleReconsent\??.*"
               value="/pages/cal/scheduleReconsent:ACCESS" />
        <entry key="/pages/cal/siteParticipantCoordinatorList\??.*"
               value="/pages/cal/siteParticipantCoordinatorList:ACCESS" />
        <entry key="/pages/sitesForAssignParticipantCoordinators\??.*"
               value="/pages/sitesForAssignParticipantCoordinators:ACCESS" />
        <entry key="/pages/cal/studyList\??.*"
               value="/pages/cal/studyList:ACCESS" />
        <entry key="/pages/cal/template\??.*"
               value="/pages/cal/template:ACCESS" />
        <entry key="/pages/cal/template/rename\??.*"
               value="/pages/cal/template/rename:ACCESS" />
        <entry key="/pages/cal/template/addTo\??.*"
               value="/pages/cal/template/addTo:ACCESS" />
        <entry key="/pages/cal/template/delete\??.*"
               value="/pages/cal/template/delete:ACCESS" />
        <entry key="/pages/cal/template/move\??.*"
               value="/pages/cal/template/move:ACCESS" />
        <entry key="/pages/editPeriod\??.*"
               value="/pages/editPeriod:ACCESS" />
        <entry key="/pages/cal/managePeriod\??.*"
               value="/pages/cal/managePeriod:ACCESS" />
        <entry key="/pages/cal/template/release\??.*"
               value="/pages/cal/template/release:ACCESS" />
        <entry key="/pages/newActivity\??.*"
               value="/pages/newActivity:ACCESS" />
        <entry key="/pages/cal/newPeriod\??.*"
               value="/pages/cal/newPeriod:ACCESS" />
        <entry key="/pages/cal/newStudy\??.*"
               value="/pages/cal/newStudy:ACCESS" />
        <entry key="/pages/cal/template/edit.js\??.*"
               value="/pages/cal/template/edit.js:ACCESS" />
        <entry key="/pages/cal/template/select\??.*"
               value="/pages/cal/template/select:ACCESS" />
    </util:map>


    <bean id="stringAuthorizationCheck" autowire="byType"
        class="gov.nih.nci.security.acegi.csm.authorization.DelegatingObjectPrivilegeCSMAuthorizationCheck">
        <property name="csmAuthorizationCheck">
            <bean class="gov.nih.nci.security.acegi.grid.authorization.CSMGridGroupAuthorizationCheck">
                <property name="csmUserProvisioningManager"
                    ref="userProvisioningManager" />
                <property name="authorizationSwitch" ref="authorizationSwitch"/>
            </bean>
        </property>
        <property name="objectIdGenerator"
            ref="stringPrivilegeAndObjectIdGenerator" />
        <property name="privilegeGenerator"
            ref="stringPrivilegeAndObjectIdGenerator" />
    </bean>

    <bean id="stringPrivilegeAndObjectIdGenerator"
        class="edu.northwestern.bioinformatics.studycalendar.security.RegexPrivilegeAndObjectIdGenerator">
        <property name="objectPrivilegeMap"
            ref="filterObjectPrivilegeMap" />
    </bean>

</beans>