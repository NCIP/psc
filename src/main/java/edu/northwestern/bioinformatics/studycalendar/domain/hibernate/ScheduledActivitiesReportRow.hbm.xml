<?xml version="1.0" encoding="utf-8"?>

<!DOCTYPE hibernate-mapping PUBLIC
    "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
    "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<hibernate-mapping>
    <class name="edu.northwestern.bioinformatics.studycalendar.domain.reporting.ScheduledActivitiesReportRow" mutable="false">
        <subselect>
            SELECT
                s_actv.id,
                s_actv.current_state_date,
                s_actv.current_state_reason,
                s_actv.current_state_mode_id,
                s_actv.ideal_date,
                s_actv.details,
                s_actv.activity_id,
                a.name AS activity_name,
                subj.id AS subject_id,
                subj.first_name,
                subj.last_name,
                subj.person_id,
                studies.id AS study_id,
                studies.assigned_identifier AS study_assigned_identifier,
                sites.id AS site_id,
                sites.name AS site_name,
                users.name AS subject_coordinator_name
            FROM
                scheduled_activities s_actv
                LEFT JOIN activities a ON a.id = s_actv.activity_id
                LEFT JOIN scheduled_study_segments s_seg ON s_seg.id = s_actv.scheduled_study_segment_id
                LEFT JOIN scheduled_calendars s_cal ON s_cal.id = s_seg.scheduled_calendar_id
                LEFT JOIN subject_assignments assign ON assign.id = s_cal.assignment_id
                LEFT JOIN subjects subj ON subj.id = assign.subject_id
                LEFT JOIN users users ON users.id = assign.subject_coordinator_id
                LEFT JOIN study_sites ssites ON ssites.id = assign.study_site_id
                LEFT JOIN studies ON studies.id = ssites.study_id
                LEFT JOIN sites ON sites.id = ssites.site_id
            ORDER BY
                s_actv.id ASC
        </subselect>
        
        <synchronize table="scheduled_activities"/>
        <synchronize table="activities"/>

        <id name="id" />

        <component name="scheduledActivity">
            <property name="id" column="id" insert="false" update="false"/>
            <property name="currentState" type="edu.northwestern.bioinformatics.studycalendar.utils.hibernate.ScheduledActivityStateType">
                <column name="current_state_mode_id"/>
                <column name="current_state_reason"/>
                <column name="current_state_date"/>
            </property>
            <property name="idealDate" column="ideal_date"/>
            <property name="details" column="details"/>
            <component name="activity">
                <property name="id" column="activity_id"/>
                <property name="name" column="activity_name"/>
            </component>
        </component>

        <component name="subject">
            <property name="id" column="subject_id"/>
            <property name="firstName" column="first_name"/>
            <property name="lastName" column="last_name"/>
            <property name="personId" column="person_id"/>
        </component>

        <component name="study">
            <property name="id" column="study_id"/>
            <property name="assignedIdentifier" column="study_assigned_identifier"/>
        </component>

        <component name="site">
            <property name="id" column="site_id"/>
            <property name="name" column="site_name"/>
        </component>
        
        <property name="subjectCoordinatorName" column="subject_coordinator_name"/>

        <filter name="filter_studyAssignedIdentifier" condition="UPPER(study_assigned_identifier) LIKE :studyAssignedIdentifier"/>
        <filter name="filter_siteName" condition="UPPER(site_name) LIKE :siteName"/>
        <filter name="filter_currentStateMode" condition="current_state_mode_id = :currentStateMode_id"/>
        <filter name="filter_activityDate_start"   condition="current_state_date &gt;= :start"/>
        <filter name="filter_activityDate_stop"    condition="current_state_date &lt;= :stop"/>
    </class>
    <filter-def name="filter_studyAssignedIdentifier">
        <filter-param name="studyAssignedIdentifier" type="string"/>
    </filter-def>
    <filter-def name="filter_siteName">
        <filter-param name="siteName" type="string"/>
    </filter-def>
    <filter-def name="filter_currentStateMode">
        <filter-param name="currentStateMode_id" type="integer"/>
    </filter-def>
        <filter-def name="filter_activityDate_start">
        <filter-param name="start" type="date"/>
    </filter-def>
    <filter-def name="filter_activityDate_stop">
        <filter-param name="stop" type="date"/>
    </filter-def>
</hibernate-mapping>