<?xml version="1.0" encoding="utf-8" ?>

<project name="caBIG Study Calendar" default="build:war" basedir=".">
    <description>Builds, tests, and runs the project psc.</description>
    <property name="download" value="${basedir}/temp/download"/>
    <property name="jruby.binaries.file" value="jruby-bin-1.3.0.zip"/>
    <property name="jruby.src.url" value="http://dist.codehaus.org/jruby/1.3.0/${jruby.binaries.file}"/>
    <property name="jruby.binaries.relative.dir" value="${download}/jruby-1.3.0"/>
    <property name="jruby.dest.file" value="${download}/${jruby.binaries.file}"/>
    <property name="path.to.jruby.bin" value="${jruby.binaries.relative.dir}/bin/jruby"/>
    <property name="path.to.jruby.bat" value="${jruby.binaries.relative.dir}/bin/jruby.bat"/>
    <property name="path.to.jruby.gems" value="${jruby.binaries.relative.dir}/lib/ruby/gems/1.8/gems"/>
    <property name="unixfamily" value="Linux,Mac OS X,Mac OS,HP UX,Digital Unix"/>
    <property name="windowsfamily" value="Windows 2000,Windows 98,Windows NT,Windows Vista,Windows XP" />
    <property environment="env"/>
    <property name="tomcat.relative.path" value="${env.CATALINA_HOME}"/>
    <property name="ccts.common.grid.src.dir" value="${env.CCTS_HOME}"/>
    <available file="${jruby.binaries.relative.dir}" property="jruby.exists" />
    <available file="${path.to.jruby.gems}/buildr-1.3.3-java" property="buildr.exists" />
    <available file="${path.to.jruby.gems}/shenandoah-0.0.0" property="shenandoah.exists" />
    <available file="${path.to.jruby.gems}/facets-2.4.5" property="facets.exists" />
    <available file="${path.to.jruby.gems}/json_pure-1.1.9" property="json_pure.exists" />
    <available file="${path.to.jruby.gems}/rest-client-1.0.3" property="rest-client.exists" />

 <!--Standard sub project build TARGETS -->
    <target name="install" depends="install:buildr,install:shenandoah,install:facets,install:json_pure,install:rest-client" description="Downloads JRuby and install require gems">
    </target>
    <target name="install:jruby" unless="jruby.exists" description="Downloads jruby">
        <mkdir dir="${basedir}/temp/download"/>
        <get src="${jruby.src.url}" dest="${jruby.dest.file}"/>
        <unzip dest="${download}" src="${jruby.dest.file}" />
        <echo message="Downloaded JRuby sucessfully"/>
        <exec executable="chmod">
            <arg line="u+x ${path.to.jruby.bin}"/>
        </exec>
        <delete dir="${jruby.dest.file}"/>
    </target>

    <target name="install:buildr" unless="buildr.exists" depends="install:jruby" description="Downloads buildr">
        <exec executable="${path.to.jruby.bin}" os="${unixfamily}" failonerror="true">
            <arg line="-S gem install buildr -v 1.3.3 --no-rdoc --no-ri"/>
        </exec>
        <exec executable="cmd" dir="." os="${windowsfamily}" failonerror="true">
            <arg line="/c ${path.to.jruby.bat} -S gem install buildr -v 1.3.3 --no-rdoc --no-ri"/>
        </exec>
    </target>

    <target name="install:shenandoah" unless="shenandoah.exists" depends="install:jruby" description="Downloads shenandoah">
        <exec executable="${path.to.jruby.bin}" os="${unixfamily}" failonerror="true">
           <arg line="-S gem install shenandoah -v 0.0.0 --no-rdoc --no-ri"/>
        </exec>
        <exec executable="cmd" dir="." os="${windowsfamily}" failonerror="true">
            <arg line="/c ${path.to.jruby.bat} -S gem install shenandoah -v 0.0.0 --no-rdoc --no-ri"/>
        </exec>
    </target>

    <target name="install:facets" unless="facets.exists" depends="install:jruby" description="Downloads facets">
        <exec executable="${path.to.jruby.bin}" os="${unixfamily}" failonerror="true">
            <arg line="-S gem install facets -v 2.4.5 --no-rdoc --no-ri"/>
        </exec>
        <exec executable="cmd" dir="." os="${windowsfamily}" failonerror="true">
            <arg line="/c ${path.to.jruby.bat} -S gem install facets -v 2.4.5 --no-rdoc --no-ri"/>
        </exec>
    </target>

    <target name="install:json_pure" unless="json_pure.exists" depends="install:jruby" description="Downloads json_pure">
        <exec executable="${path.to.jruby.bin}" os="${unixfamily}" failonerror="true">
            <arg line="-S gem install json_pure -v 1.1.9 --no-rdoc --no-ri"/>
        </exec>
        <exec executable="cmd" dir="." os="${windowsfamily}" failonerror="true">
            <arg line="/c ${path.to.jruby.bat} -S gem install json_pure -v 1.1.9 --no-rdoc --no-ri"/>
        </exec>
    </target>

    <target name="install:rest-client" unless="rest-client.exists" depends="install:jruby" description="Downloads rest-client">
        <exec executable="${path.to.jruby.bin}" os="${unixfamily}" failonerror="true">
            <arg line="-S gem install rest-client -v 1.0.3 --no-rdoc --no-ri"/>
        </exec>
        <exec executable="cmd" dir="." os="${windowsfamily}" failonerror="true">
            <arg line="/c ${path.to.jruby.bat} -S gem install rest-client -v 1.0.3 --no-rdoc --no-ri"/>
        </exec>
    </target>

    <target name="build:war" depends="install">
        <exec executable="${path.to.jruby.bin}" os="${unixfamily}" failonerror="true">
            <arg line="-S buildr build test=no"/>
        </exec>
        <exec executable="cmd" dir="." os="${windowsfamily}" failonerror="true">
            <arg line="/c ${path.to.jruby.bat} -S buildr build test=no"/>
        </exec>
    </target>

    <target name="deploy:psc:webapp" description="Deploy pre-built war file">
        <delete dir="${tomcat.relative.path}/webapps/psc.war" />
        <copy todir="${tomcat.relative.path}/webapps" file="${basedir}/web/target/psc.war"/>
    </target>

    <target name="build:deploy:psc:webapp" depends="build:war" description="Build and Deploy war file ">
        <delete dir="${tomcat.relative.path}/webapps/psc.war" />
        <copy todir="${tomcat.relative.path}/webapps" file="${basedir}/web/target/psc.war"/>
    </target>

    <target name="deploy:psc:grid" depends="install">
        <exec executable="${path.to.jruby.bin}" os="${unixfamily}" failonerror="true">
            <arg line="-S buildr psc:grid:deploy_with_globus test=no wsrf_dir_name=wsrf-psc"/>
            <env key="CATALINA_HOME" value="${tomcat.relative.path}"/>
            <env key="CCTS_HOME" value="${ccts.common.grid.src.dir}"/>
        </exec>
        <exec executable="cmd" dir="." os="${windowsfamily}" failonerror="true">
            <arg line="/c ${path.to.jruby.bat} -S buildr psc:grid:deploy_with_globus test=no wsrf_dir_name=wsrf-psc"/>
            <env key="CATALINA_HOME" value="${tomcat.relative.path}"/>
            <env key="CCTS_HOME" value="${ccts.common.grid.src.dir}"/>
        </exec>
    </target>
    
    <target name="clean" depends="install">
        <exec executable="${path.to.jruby.bin}" os="${unixfamily}" failonerror="true">
            <arg line="-S buildr clean"/>
        </exec>
        <exec executable="cmd" dir="." os="${windowsfamily}" failonerror="true">
            <arg line="/c ${path.to.jruby.bat} -S buildr clean"/>
        </exec>
    </target>

    <target name="clean-download">
        <delete dir="${download}" />
    </target>
</project>